使用Https协议访问时，会碰到证书的问题。有时候开发https 相关的程序时，也需要自制证书。制作证书时，总是需要 .key, .csr, . crt 三类文件。 并且，对不同对象制作证书时，需要用到并产生多个这样的文件，弄不清作用，容易使用混淆。这三类文件的作用是什么，又与哪些技术相关？带着这些问题，对自己的认知进行一些总结记录。

## 数据加密

1.  对称加密 加解密都用同一种秘钥， 适合于内容量大的加密场景。
    
2.  非对称加密 加解密秘钥不同。
    
    -   公钥加密–>私钥解密 ： 用于加密，只有私钥持有者才能解密。但是风险大，公钥是公开的，任何人都可以用公钥加密信件，无法验证发信人身份。
    -   私钥加密–> 公钥解密：用于数字签名，验证身份。鉴于私钥是保密的，任何第三者无法拿到私钥的情形成立，因此，可以用私钥加密的方式来确认信件的发送方。但是也有风险，比如B持有的A的公钥被替换成C的公钥，而B 对此不知情， C用自己的私钥 假冒A给B 发送信件。

## 数字签名

简而言之： 发信人对内容进行hash 计算，得到内容摘要（digest）–> 发信人对摘要使用私钥加密，生成”数字签名”（signature） –> 内容附上数字签名，一起发送。

![1685794630450](image/加密与解密+git签名+ca证书签发/1685794630450.png)

身份验证过程：

![1685794636376](image/加密与解密+git签名+ca证书签发/1685794636376.png)

前文说到，用数字签名的方式 发送信件也是有一定风险的。比如**公钥被替换，无法知晓公钥的来源或公钥对应的私钥的持有者身份**。于是，数字证书便有了它的作用。

## 数字证书

内容：含有公钥，及公钥拥有者的身份。

作用：1. **证明证书中的公钥 就是信件发送者的的公钥** ； 2. 用通过认证的公钥解密内容

特点：1. 第三方权威机构颁发；2. 具有有效期

数字证书使用：

1.  由证书认证机构（CA）对证书申请者真实身份验证之后，用CA的根证书对申请人的一些基本信息以及申请人的公钥进行签名后形成的一个数字文件，生成”数字证书”（Digital Certificate）；
    
2.  A 在发送信件给B的时候，同时附上签名和证书；
    
3.  B 用CA的公钥解开数字证书，就可以拿到A 的真实公钥了，然后就能证明”数字签名”的是否属A。
    

在说完数字签名，数字证书产生的意义后，下边将说一说平时开发程序时证书的x509 的制作过程

## 证书制作

在说明证书制作过程前，先说明制作证书时，用到的几类文件的作用

.key 文件：私钥

.csr 文件：证书签名请求文件，含有公钥信息，certificate signing request的缩

.crt 文件：用.csr 生成的证书文件，certificate的缩写,这就是数字证书

**自制证书**

1.  生成自签名根证书。就是模仿证书权威机构的作用，给用户提供一个权威机构的根证书。在真实场景中，根证书是CA认证中心给自己颁发的证书,是信任链的起始点。任何安装CA根证书的服务器都意味着对这个CA认证中心是信任的。是信任链的起始点。任何安装CA根证书的服务器都意味着对这个CA认证中心是信任的。
    
    -   生成CA 的私钥 `openssl genrsa -out ca.key 2048`
        
    -   生成CA 证书请求文件 `openssl req -new -key ca.key -out ca.csr`
        
    -   生成CA证书 `openssl x509 -req -days 365 -in ca.csr -signkey ca.key -out ca.crt`
        
    
    
    
2.  生成用户证书
    

同样用到以上三步，但是在最后生成用户证书的时候，用到了ca.crt, ca.key 文件。

```
openssl genrsa -des3 -out server.key 1024 
openssl req -new -key server.key -out server.csr
$openssl ca -in server.csr -out server.crt -cert ca.crt -keyfile ca.key 
```

1.  使用证书

服务端应用程序应该提供添加证书的方法，证书的路径。

浏览器作为客户端去访问https加密的服务器，一般不用去手动做其他设置，这是因为Chrome、FireFox、IE等浏览器已经内置了大部分常用的CA的根证书，但自建CA的根证书就不在浏览器的信任列表中，客户端需要自己导入刚才自己制作的CA根证书。

对于Linux 系统用curl 测试时，可以用`--cacert CA_PATH`手动指定根证书路径。